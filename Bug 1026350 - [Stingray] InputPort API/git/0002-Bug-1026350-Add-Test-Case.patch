From 0b9987a926ffe24cd24a78301f6390ec67026afa Mon Sep 17 00:00:00 2001
From: James Cheng <jacheng@mozilla.com>
Date: Thu, 5 Mar 2015 13:45:13 +0800
Subject: [PATCH 2/2] Bug 1026350 - Add Test Case

---
 dom/inputport/moz.build                            |  6 +-
 dom/inputport/test/mochitest/mochitest.ini         |  3 +
 .../mochitest/test_inputport_get_inputports.html   | 64 ++++++++++++++++++++++
 dom/inputport/test/xpcshell/test_inputport_data.js | 61 +++++++++++++++++++++
 dom/inputport/test/xpcshell/xpcshell.ini           |  5 ++
 5 files changed, 138 insertions(+), 1 deletion(-)
 create mode 100644 dom/inputport/test/mochitest/mochitest.ini
 create mode 100644 dom/inputport/test/mochitest/test_inputport_get_inputports.html
 create mode 100644 dom/inputport/test/xpcshell/test_inputport_data.js
 create mode 100644 dom/inputport/test/xpcshell/xpcshell.ini

diff --git a/dom/inputport/moz.build b/dom/inputport/moz.build
index 9718a0c..7358349 100644
--- a/dom/inputport/moz.build
+++ b/dom/inputport/moz.build
@@ -35,13 +35,17 @@ UNIFIED_SOURCES += [
 ]
 
 XPIDL_SOURCES += [
     'nsIInputPortService.idl',
 ]
 
 XPIDL_MODULE = 'dom_inputport'
 
+MOCHITEST_MANIFESTS += ['test/mochitest/mochitest.ini']
+
+XPCSHELL_TESTS_MANIFESTS += ['test/xpcshell/xpcshell.ini']
+
 include('/ipc/chromium/chromium-config.mozbuild')
 
 FINAL_LIBRARY = 'xul'
 
-FAIL_ON_WARNINGS = True
+FAIL_ON_WARNINGS = True
\ No newline at end of file
diff --git a/dom/inputport/test/mochitest/mochitest.ini b/dom/inputport/test/mochitest/mochitest.ini
new file mode 100644
index 0000000..6e624ed
--- /dev/null
+++ b/dom/inputport/test/mochitest/mochitest.ini
@@ -0,0 +1,3 @@
+[DEFAULT]
+
+[test_inputport_get_inputports.html]
\ No newline at end of file
diff --git a/dom/inputport/test/mochitest/test_inputport_get_inputports.html b/dom/inputport/test/mochitest/test_inputport_get_inputports.html
new file mode 100644
index 0000000..fd7a095
--- /dev/null
+++ b/dom/inputport/test/mochitest/test_inputport_get_inputports.html
@@ -0,0 +1,64 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=1026350
+-->
+<head>
+<meta charset="utf-8">
+<title>Inputport API Test</title>
+<link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css"/>
+  <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1026350">Test Inputport API</a>
+<script type="application/javascript;version=1.8">
+
+'use strict';
+
+SimpleTest.waitForExplicitFinish();
+
+function testGetInputports() {
+  return new Promise(function(resolve, reject) {
+    var inputPortMgr = navigator.inputPortManager;
+    inputPortMgr.getInputPorts().then(
+      function(aPorts) {
+        ok(aPorts.length > 0, "Got at least 1 inputport.");
+        for (var i=0; i < aPorts.length; ++i) {
+          var port = aPorts[i];
+          ok(port instanceof InputPort, "Inputport " + i + " should be in the right type.");
+          ok('id' in port, "Inputport " + i + " should have an ID.");
+          ok('type' in port, "Inputport " + i + " should have a type.");
+          ok('connected' in port, "Inputport " + i + " should have a connected property.");
+          ok(!port.stream, "Inputport " + i + " should have no stream by default.");
+          resolve();
+        }
+      },
+      function(aError) {
+        ok(false, "Fail to get input ports: " + aError);
+        resolve();
+      }
+    );
+  });
+}
+
+function runTest() {
+  ok(navigator.inputPortManager, 'should have navigator.inputPortManager');
+
+  testGetInputports()
+  .then(function() {
+    info('test finished');
+    SimpleTest.finish();
+  });
+}
+
+SpecialPowers.pushPrefEnv({"set": [["dom.inputport.enabled", true],
+                                    //to ignore app scope check.
+                                   ["dom.ignore_webidl_scope_checks", true]]}, function() {
+  SpecialPowers.pushPermissions(
+    [{'type': 'inputport', 'allow': true, 'context': document}], runTest);
+});
+
+ </script>
+ </pre>
+ </body>
+ </html>
diff --git a/dom/inputport/test/xpcshell/test_inputport_data.js b/dom/inputport/test/xpcshell/test_inputport_data.js
new file mode 100644
index 0000000..15fb377
--- /dev/null
+++ b/dom/inputport/test/xpcshell/test_inputport_data.js
@@ -0,0 +1,61 @@
+"use strict";
+
+const {classes: Cc, interfaces: Ci, utils: Cu, results: Cr} = Components;
+
+function run_test() {
+  run_next_test();
+}
+
+add_test(function test_valid_inputport_id() {
+  var inputportId = "inputportId";
+
+  var data = Cc["@mozilla.org/inputport/inputportdata;1"].
+             createInstance(Ci.nsIInputPortData);
+  data.id = inputportId;
+
+  equal(data.id, inputportId);
+
+  run_next_test();
+});
+
+add_test(function test_empty_inputport_id() {
+  var data = Cc["@mozilla.org/inputport/inputportdata;1"].
+             createInstance(Ci.nsIInputPortData);
+  Assert.throws(function() {
+    data.id = "";
+  }, /NS_ERROR_ILLEGAL_VALUE/i);
+
+  run_next_test();
+});
+
+add_test(function test_valid_type() {
+  var  inputportType = "hdmi";
+
+  var data = Cc["@mozilla.org/inputport/inputportdata;1"].
+             createInstance(Ci.nsIInputPortData);
+  data.type = inputportType;
+
+  equal(data.type, inputportType);
+
+  run_next_test();
+});
+
+add_test(function test_empty_type() {
+  var data = Cc["@mozilla.org/inputport/inputportdata;1"].
+             createInstance(Ci.nsIInputPortData);
+  Assert.throws(function() {
+    data.type = "";
+  }, /NS_ERROR_ILLEGAL_VALUE/i);
+
+  run_next_test();
+});
+
+add_test(function test_is_connected() {
+  var data = Cc["@mozilla.org/inputport/inputportdata;1"].
+             createInstance(Ci.nsIInputPortData);
+  data.connected = true;
+
+  ok(data.connected);
+
+  run_next_test();
+});
diff --git a/dom/inputport/test/xpcshell/xpcshell.ini b/dom/inputport/test/xpcshell/xpcshell.ini
new file mode 100644
index 0000000..77bdcda
--- /dev/null
+++ b/dom/inputport/test/xpcshell/xpcshell.ini
@@ -0,0 +1,5 @@
+[DEFAULT]
+head =
+tail =
+
+[test_inputport_data.js]
\ No newline at end of file
-- 
1.9.1

